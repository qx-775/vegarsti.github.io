---
layout: post
title: Gathering a city bike data set by API requests in Python
---

In Oslo, there is a really nice [city bike service](https://oslobysykkel.no/en), and it is increasingly improving. They have a [developer API](https://developer.oslobysykkel.no) which you can call to find how many bikes are currently available at each station. In this post, I will create a script which does this, and which we then set up to run every 5 minutes to log the availabilities, so that we can look more closely at how bikes move around.

## Making a request
First, you need to [sign up](https://developer.oslobysykkel.no/sign-up) to get an identifier, which will be our key to access the API. Let's say our key is `12345abcd`. Store this in a file, e.g., a Python file called `secrets.py`, like so

```python
secret = '1234abcd'
```

We can try making a request to the service by using `curl`, doing

```bash
curl -H "Client-Identifier: "1234abcd"" \
  https://oslobysykkel.no/api/v1/stations/availability
```
and in return we get a JSON string. So far so good. Let's try doing this in Python.

## Extracting data
A good library for doing HTML requests (or API calls) is [`requests`](https://pypi.org/project/requests/). What we're interested in for now is the availability of a station. We write the following small program,

```python
import requests

from secret import identifier

url = 'https://oslobysykkel.no/api/v1/stations/availability'
headers = {'Client-Identifier': identifier}
r = requests.get(url, headers=headers)

result = r.json()
stations = result['stations']
first_station = stations[0]

for key, value in first_station.items():
    print(key, value)
```

which will print something like this:

```
id 430
availability {'bikes': 0, 'locks': 24}
```
In other words, we get a station id and the number of bikes and locks currently available. Another thing available in the JSON is the timestamp that the availability data was updated. We get that by accessing `result['updated_at']`. It looks like `2016-09-09T09:50:33+00:00`. If we are only interested in the date and the time in hour and minutes, we can do

```python
timestamp = result['updated_at']
date, time = timestamp[:16].split('T')
```

We now have the data we need to make a log file, or data set, of the availabilities. We add some lines extracting the data,

```python
for station in stations:
    id_ = station['id']
    bikes = station['availability']['bikes']
    locks = station['availability']['locks']
```
and if we also do `print(f"{date},{time},{id_},{bikes},{locks}")`, we get nice comma separated data about each station with time:

```
2018-05-03,11:59,432,1,25
```
We can now make a complete script which writes this data to file. To do this we need to open a file and append the data to it. (By using the flag `'a'` to the `open` function call, we append to the file, and if it doesn't exist, it's created.)

```python
with open(filename, 'a') as datafile:
    for station in stations:
        ...
        datafile.write(f"{date},{time},{id_},{bikes},{locks}\n")
```

We have now made a script which makes a request, extracts the relevant data, and writes it to a file. See [here](https://github.com/vegarsti/OsloCityBike/blob/master/availabilities2file.py) for the complete script. What is missing is to automate the process.

## Automating
We can do this by using  `cron`, which is a time-based job scheduler utility. `cron`, along with `curl`, should be available on a Unix system, such as macOS, which I am using. To add a job to `cron`, we can do `env EDITOR=nano crontab -e`. This opens the `nano` editor and the `crontab` table. Each line here defines when and what commands or scripts to run. I ran into some problems when calling the Python script directly, so the solution was to create a `bash` script called `call_script.sh`, which only contains

```bash
#!/bin/sh

my/python/path/python3 availabilities2file.py
```
where `my/python/path` is the path to the Python interpreter we want to use. To make sure this is executable, we do `chmod +x call_script.sh`. We are now ready to add a line to the `crontab` table, and we want to run the command every 5 minutes, between 6AM and midnight:

```
*/5 6-23 * * * cd ~/Documents/dev/OsloCityBike/ && ./call_script.sh
```

We have now started collecting a city bike data set, which should be ready for inspection at a later time!

All code is available at [Github](https://github.com/vegarsti/OsloCityBike).